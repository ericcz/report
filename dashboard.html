<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DashBoard</title>
<link rel="stylesheet" href="include/css/bootstrap.css">
<link rel="stylesheet" href="include/css/bootstrap-datetimepicker.css">
<style>
body {padding:20px;background-color:#777;}
ul,li {list-style:none}
.sect {float:left;border-radius:4px;background:white;box-shadow:0 0 8px #222; font:16px/1.5em 'Microsoft YaHei';width:30%;height:220px;background-color:#fff}
.dv-title {width:100%;height:40px;background-color:#eee;padding:10px}
.font1 {font:80px/1.5em 'Microsoft YaHei';color:#33cccc;}
.font2 {font:60px/1.5em 'Microsoft YaHei';color:#cc6666;}
.font3 {font:30px/1.5em 'Microsoft YaHei';color:#0099CC;}
.font4 {font:20px/1.5em 'Microsoft YaHei';color:#f60;}
.font5 {font:40px/1.5em 'Microsoft YaHei';color:#0099CC;}
.dv-register {padding:5px;float:left;margin:1px;background-color:#e06;color:#fff;width:49.24%;height:40%;}
.th {cursor:pointer;}
</style>
<script src="include/js/jquery-3.0.0.min.js"></script>
<script src="include/js/bootstrap.min.js"></script>
<script src="include/js/bootstrap-datetimepicker.js"></script>
<script src="include/js/highcharts.js"></script>
<script src="include/js/jquery.bootstrap.newsbox.min.js"></script>
<script type="text/javascript">
function showChart_lineBasic(cData,cTitle,content,xRay){
	var chart;
	var options = {
			chart: {
				renderTo: content,
				defaultSeriesType: 'line',
				marginRight: 110,
				marginBottom: 25
			},
			title: {
				text: cTitle,
				x: -20 
			},
			subtitle: {
				text: '',
				x: -20
			},
			xAxis: {
				categories: xRay
			},
			yAxis: {
				title: {
					text: ''
				},
			plotLines: [{
				value: 0,
				width: 1,
				color: '#808080'
			}]
			},
			tooltip: {
				formatter: function() {
						return '<b>'+ this.series.name +'</b>'+
						this.x +': '+ this.y +'';
				}},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				x: -10,
				y: 100,
				borderWidth: 0
			},
			series:[]
		};
		var v,arr=new Array(),a=new Array();
		for (var i=0;i<cData.split(';').length;i++){
			arr=cData.split(';')[i].split(',');
			v=arr[0];
			arr.shift();
			for(var j=0;j<arr.length;j++){
				a[j]=parseInt(arr[j]);
			}
			options.series.push({name:v,data:a});
			a=[]
		}
		chart = new Highcharts.Chart(options);
}
function createXMLHttpRequest(url,dv){
	xmlhttp=""
	if(window.ActiveXObject){
		try{
		xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		}catch(e){
		xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		}}
		else if(window.XMLHttpRequest){
			xmlhttp = new XMLHttpRequest();
				if (xmlhttp.overrideMimeType){ xmlhttp.overrideMimeType("text/xml");}
		}
		if(!xmlhttp){ window.alert("Do not support XMLHttpRequest!");}
		xmlhttp.onreadystatechange=XHRChanged;
		xmlhttp.open("POST", url,false);
		xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		xmlhttp.send(dv);
}
function XHRChanged(){	//handle return value xmlhttp.responseText
	if (xmlhttp.readyState==4){
		getBack(xmlhttp.responseText);}
}
function getBack(vchReturn){
try{
	var vf=vchReturn.split("##")[1]
	if (vf=='getDashBoard'){
		var rt,dsc
		rt=vchReturn.split("##")[2].split("$$")[2].split(",");
		if (parseInt(rt[rt.length-1])>parseInt(rt[rt.length-2])){
			dsc='<span style="color:#0099CC">+</span>';
		}else
			dsc='<span style="color:#fff"></span>';
		$(".dv-down1").html("<span class=font1>"+rt[rt.length-1]+"</span><span class=font3>"+dsc+"&nbsp;"+Math.round((rt[rt.length-1]-rt[rt.length-2])/rt[rt.length-2]*10000)/100+"%</span>")
		$(".dv-down2").html("<br><span class=font4>总下载数："+vchReturn.split("##")[2].split("$$")[3]+"</span>")

		rt=vchReturn.split("##")[3].split("$$")[2].split(",");
		if (parseInt(rt[rt.length-2])>parseInt(rt[rt.length-3])){
			dsc='<span style="color:#fff">+</span>';
		}else
			dsc='<span style="color:#fff"></span>';
		$(".dv-register-l1").html(rt[rt.length-1]);
		$(".dv-register-l2").html(vchReturn.split('##')[3].split('$$')[3]);
		$(".dv-register-r1").html(rt[rt.length-2]+"<br><span style='font-size:20px'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+dsc+Math.round((rt[rt.length-2]-rt[rt.length-3])/rt[rt.length-3]*10000)/100+"%</span>");
		
		rt=vchReturn.split("##")[4].split("$$")[2].split(",");
		if (parseInt(rt[rt.length-1])>parseInt(rt[rt.length-2])){
			dsc='<span style="color:#fff;font-size:36px">+</span>';
		}else
			dsc='<span style="color:#fff;"></span>';
		$(".dv-act1").html("<span class=font1 style='color:#fff'>"+rt[rt.length-1]+"</span>");
		$(".dv-act2").html("<span class=font3 style='color:#fff;'>"+dsc+Math.round((rt[rt.length-1]-rt[rt.length-2])/rt[rt.length-2]*10000)/100+"%</span>");
		
		rt=vchReturn.split("##")[5].split("$$");
		$(".td-lv-d").html(rt[1]+'%');
		rt=vchReturn.split("##")[6].split("$$");
		$(".td-lv-w").html(rt[1]+'%');
		rt=vchReturn.split("##")[7].split("$$");
		$(".td-lv-m").html(rt[1]+'%');

		rt=vchReturn.split("##")[8].split("$$")[2].split(",");
		if (parseInt(rt[rt.length-1])>parseInt(rt[rt.length-2])){
			dsc='<span style="color:#0099CC">+</span>';
		}else
			dsc='<span style="color:#fff"></span>';
		$(".td-pv").html(rt[1]+"<span class=font4 style='color:#0099CC'>"+"&nbsp;&nbsp;&nbsp;"+dsc+Math.round((rt[rt.length-1]-rt[rt.length-2])/rt[rt.length-2]*10000)/100+"%</span>");
		
		rt=vchReturn.split("##")[9].split("$$")[2].split(",");
		if (parseInt(rt[rt.length-1])>parseInt(rt[rt.length-2])){
			dsc='<span style="color:#0099CC">+</span>';
		}else
			dsc='<span style="color:#fff"></span>';
		$(".td-uv").html(rt[1]+"<span class=font4 style='color:#0099CC'>"+"&nbsp;&nbsp;&nbsp;"+dsc+Math.round((rt[rt.length-1]-rt[rt.length-2])/rt[rt.length-2]*10000)/100+"%</span>");
		
		rt=vchReturn.split("##")[10].split("$$");
		$(".ul-loc").html(rt[1]);
		$(".ul-loc").bootstrapNews({
		newsPerPage: 1,
		autoplay: true,
		pauseOnHover:true,
		direction: 'down',
		newsTickerInterval: 4000,
		navigation: false,
		onToDo: function (){
			//console.log(this);
			}
		});

	}else{
		$(".tab").html(vchReturn.split("##")[2]);
		var v=$(".hid-pr").val();
		if(v.substr(0,4)!="left" && v!="point" && v!="time" && v!="interval"){
			var pr=0;
			var amount="";
			for (i=0;i<7;i++){
				pr=0
				$(".col"+i).each(function(){
					pr+=parseInt($(this).html());
				});
				amount+="<td>"+pr+"</td>"
			}
			amount="<tr><td style='width:10%'>合计</td>"+amount+"</table>"
			$(".tab").html($(".tab").html().replace('</table>',amount));
		}
		if(v=="interval"){
			var pr=0,total=0;
			var amount="";
			for (i=0;i<7;i++){
				pr=0;
				total=0;
				$(".col"+i).each(function(index){
					pr+=parseInt($(this).html());
					total+=parseInt($(this).html())*parseInt($(".tr"+index).attr('type'));
				});
				if (pr>0){
				pr=Math.round(total/pr);}
				amount+="<td>"+pr+"</td>"
			}
			amount="<tr><td style='width:10%'>平均时长(秒)</td>"+amount+"</table>"
			$(".tab").html($(".tab").html().replace('</table>',amount));
		}
		if (v=="pv"||v=="uv"){
			var chartDt= new Array
			chartDt=vchReturn.split("##")[3].split(",");
			var chartData=vchReturn.split("##")[4];
			showChart_lineBasic(chartData.substring(0,chartData.length-1),"","chart",chartDt);
			$("#chart").show()
		}
		if(v=="loc" || v=="time"){
			$(".tab").css("overflow","scroll").css("overflow-x","hidden").css("height","450px")
		}
		$(".dv-ext").show();
		$(".dv-ext-in").show();
		$(".th").click(function(){
			var arr,vJason="",dc=""
			arr=$(".tbody").html().split("<tr");
			$(".col"+$(this).attr('type')).each(function(index){
				vJason+='{"val":'+parseInt($(this).html())+',"id":'+(index+1)+'},';
			});	
			vJason=vJason.substr(0,vJason.length-1)
			vJason=eval("(["+vJason+"])")
			vJason.sort(function(a,b){
				return b.val - a.val;
			});
			for(i=0;i<vJason.length;i++){
				dc+= "<tr"+arr[vJason[i].id]
			}
			$(".tbody").html(dc)
		})
		switch(v){
			case 'down':
				$(".title").html("下载渠道");
				break;
			case 'reg':
				$(".title").html("注册来源");
				break;
			case 'lively':
				$(".title").html("活跃渠道");
				break;
			case 'pv':
				$(".title").html("PV版块");
				break;
			case 'uv':
				$(".title").html("UV版块");
				break;
			case 'leftD':
				$(".title").html("日留存");
				break;
			case 'leftW':
				$(".title").html("周留存");
				break;
			case 'leftM':
				$(".title").html("月留存");
				break;
			case 'time':
				$(".title").html("APP使用时点");
				break;
			case 'launch':
				$(".title").html("APP启动");
				break;
			case 'interval':
				$(".title").html("APP使用时长");
				break;
			case 'point':
				$(".title").html("积分范围");
				$(".cale").css('display','none')
				$(".tab").css('margin-top','60px')
				break;
		}
	}
		}catch(e){ alert(e);}
}
$(document).ready(function(){

	setTimeout(function(){
	url="dashboardGet.php?pid="+escape(document.cookie.split('#')[0])+"&obj="+escape("getDashBoard");
	createXMLHttpRequest(url,"fresh=" +Math.random());
	},300);
	
	$(".tr-lv").click(function(){
		$(".hid-pr").val($(this).attr("type"));
		var v
		if ($(this).attr("type")=="point"){
			v="getDetailPoint";
		}else
			v="getDetail";
		url="dashboardGet.php?pid="+escape(document.cookie.split('#')[0])+"&obj="+escape(v)+"&dt="+escape($('#iph-d-start').val())+"&typ="+escape($(this).attr("type"));
		createXMLHttpRequest(url,"fresh=" +Math.random());
	})
	$('.tab-show').click(function(){
		$(".hid-pr").val($(this).attr("type"));
		url="dashboardGet.php?pid="+escape(document.cookie.split('#')[0])+"&obj="+escape("getDetail")+"&dt="+escape($('#iph-d-start').val())+"&typ="+escape($(".hid-pr").val());
		createXMLHttpRequest(url,"fresh=" +Math.random());
	})
	$('.bt-exec').click(function(){
		if($(".hid-pr").val()=="point"){
			return false;
		}
		url="dashboardGet.php?pid="+escape(document.cookie.split('#')[0])+"&obj="+escape("getDetail")+"&dt="+escape($('#iph-d-start').val())+"&typ="+escape($(".hid-pr").val());
		createXMLHttpRequest(url,"fresh=" +Math.random());
	})

	$('.tab-close').click(function(){
		$(".dv-ext").hide();
		$(".dv-ext-in").hide();
		$('#ip-d-start').val(vdt)
		$('#iph-d-start').val(vdt)
		$("#chart").hide();
		$(".tab").css("overflow","auto").css("height","").css("margin-top","-20px");
		$(".cale").css("display","block")
	})

})
</script>
</head>
<body>
<div id="container" >

<section class="sect-down sect" style="margin-left:4%;">
<div class="dv-title">昨日下载
<span class="glyphicon glyphicon-th-list tab-show" aria-hidden="true" style="float:right;cursor:pointer" type="down"></span>
</div>
<div class="dv-down1" style="padding:10px;width:100%;height:50%;text-align:center"></div>
<div class="dv-down2" style="padding:10px;width:100%;height:30%;text-align:right"></div>
</section>

<section class="sect-reg sect" style="margin-left:15px;">
<div class="dv-title">注册
<span class="glyphicon glyphicon-th-list tab-show" aria-hidden="true" style="float:right;cursor:pointer" type="reg"></span>
</div>
<div class="dv-register">
<div>今日</div><div class="dv-register-l1" style="font-size:60px;text-align:center"></div>
</div>
<div class="dv-register">
<div>昨日</div><div class="dv-register-r1" style="font-size:40px;text-align:center;"></div>
</div>
<div class="dv-register" style="width:99%;">
<div>总注册</div><div class="dv-register-l2" style="font-size:70px;text-align:center"></div>
</div>
</section>

<section class="sect-active sect" style="margin-left:15px;background-color:#ffcc00">
<div class="dv-title">昨日活跃
<span class="glyphicon glyphicon-th-list tab-show" aria-hidden="true" style="float:right;cursor:pointer" type="lively"></span>
</div>
<div class="dv-act1" style="padding:10px;width:100%;height:50%;text-align:center"></div>
<div class="dv-act2" style="padding:10px;width:100%;height:30%;text-align:right"></div>
</section>
<br>

<section class="sect-left sect" style="margin-left:4%;margin-top:10px">
<div class="dv-title">留存率</div>
<table class="table table-hover font4" style="height:80%;cursor:pointer;">
<tr class='tr-lv info' type='leftD'><td>日留存</td><td class='td-lv-d'></td></tr>
<tr class='tr-lv warning' type='leftW'><td>周留存</td><td class='td-lv-w'></td></tr>
<tr class='tr-lv active' type='leftM'><td>月留存</td><td class='td-lv-m'></td></tr>
</table>
</section>

<section class="sect-pv sect" style="margin-left:15px;margin-top:10px;">
<div class="dv-title">PV & UV</div>
<table class="table table-hover font5" style="height:80%;cursor:pointer;">
<tr class='tr-lv info' type='pv'><td valign="middle">PV</td><td class='td-pv'></td></tr>
<tr class='tr-lv warning' type='uv'><td>UV</td><td class='td-uv'></td></tr>
</table>
</section>

<section class="sect-ca sect" style="margin-left:15px;margin-top:10px;">
<div class="dv-title">用户行为</div>
<table class="table table-hover font4" style="cursor:pointer;">
<tr class='tr-lv info' type='point'><td>积分范围</td><td class='td-point'></td></tr>
<tr class='tr-lv active' type='launch'><td>APP启动数</td><td class='td-launch'></td></tr>
<tr class='tr-lv warning' type='time'><td>APP时段</td><td class='td-time'></td></tr>
<tr class='tr-lv success' type='interval'><td>APP用户时长</td><td class='td-interval'></td></tr>
</table>
</section>
<br>
<section class="sect-loc sect" style="margin-left:4%;margin-top:10px;height:160px;">
<div class="dv-title">日活省分布
<span class="glyphicon glyphicon-th-list tab-show" aria-hidden="true" style="float:right;cursor:pointer" type="loc"></span>
</div>
<div class="panel panel-default font3" style="margin-top:10px">
<div class="panel-body">
<ul class="ul-loc">
</ul>
</div></div>
</section>

<div class="dv-ext" style='z-index:1;left:0px;top:0px;position:absolute;background-color:#666;width:100%;height:100%;filter:alpha(opacity=90);opacity:0.9;display:none;'></div>
<div class='dv-ext-in' style="z-index:10;left:0px;top:0px;position:absolute;background-color:#fff;width:99%;height:90%;top:5%; border-radius:8px;display:none;">
<div class="cale" style="padding:20px;width:300px;">
	<div class="input-group date form_date col-md-2" data-date="" data-date-format="yyyy-mm-dd" data-link-field="iph-d-start" data-link-format="yyyy-mm-dd" >
	<input id="ip-d-start" class="form-control" size="12" type="text" value="" readonly style='width:120px' placeholder="PickDate">
	<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
	</div>
	<button type="submit" class="btn btn-info bt-exec btn-sm" id="bt-exec" style="margin-top:-54px;margin-left:165px" type=''>
	<span>Execute</span>
	</button><input type="hidden" id="iph-d-start" value="" />
</div>
<div class="tab" style="margin-top:-20px;padding:0px 20px 20px 20px;width:90%;"></div>
<div style="z-index:12;left:96%;position:absolute;top:3%;cursor:pointer">
<span class="glyphicon glyphicon-remove tab-close" aria-hidden="true" style="color:#000;"></span></div>
<div id="chart" style="margin:-40px 0px 0px 50px;width:70%;height:250px;display:none;"></div>
</div>

<input type=hidden class='hid-pr'/>
</div>
</body>
<script type="text/javascript">
	var dt = new Date();
	var m="0"+(dt.getMonth()+1);
	var d="0"+(dt.getDate()-1);
	vdt=dt.getFullYear()+"-"+m.substr(m.length-2,2)+"-"+d.substr(d.length-2,2);
	$('#ip-d-start').val(vdt)
	$('#iph-d-start').val(vdt)

	$('.form_date').datetimepicker({
        language: 'en',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
	$('.form_date').datetimepicker('setEndDate',vdt);

</script>
</html>